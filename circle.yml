machine:
  services:
    - docker

dependencies:

  cache_directories:
    - "~/.local"  # cache pip programs
    - "~/.docker" # cache docker images

  pre:
    - sudo pip install docker-compose
    - if [ -f ~/.docker/images.tar ]; then docker load -i ~/.docker/images.tar; fi

  override:
    - git diff --name-only `basename $CIRCLE_COMPARE_URL` | cut -d'/'  -f-1 | uniq | xargs -I {} docker-compose -f {}/docker-compose.test.yml up app

  post:
    - if [ ! -f ~/.docker/images.tar ]; then mkdir -p ~/.docker; docker save -o ~/.docker/images.tar $(docker images | grep -v '^REPOSITORY' | grep -v '^<none>' | awk '{print $1}' | uniq); fi

test:

  override:
    - git diff --name-only `basename $CIRCLE_COMPARE_URL` | cut -d'/'  -f-1 | uniq | xargs -I {} docker-compose -f {}/docker-compose.test.yml up test
